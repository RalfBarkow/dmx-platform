maven-build:
  stage: build
  script:
    - mvn clean install -P all,dist -DskipTests

copy-and-deploy:
  stage: deploy
  only:
    - master
  script:
    # copy to download area
    - DISTDIR='modules/dmx-distribution/target'
    - pwd
    - ls -la
    - ls -la ${DISTDIR}
    - ZIPFILE="$( ls ${DISTDIR}/*.zip )"
    - FILENAME="$( basename ${ZIPFILE} .zip )"
    - NUNC="$( date +%F )"
    - MY_JOB_TOKEN="$(</home/gitlab-runner/.after-maven-build.token)"
    - cp ${DISTDIR}/${FILENAME}.zip /var/www/download.dmx.systems/ci/${FILENAME}_${NUNC}_${CI_PIPELINE_ID}.zip
    - ln -sf /var/www/download.dmx.systems/ci/${FILENAME}_${NUNC}_${CI_PIPELINE_ID}.zip /var/www/download.dmx.systems/ci/dmx-latest.zip
    # trigger `dmx-build-deb` pipeline
    - curl -X POST -F token="${MY_JOB_TOKEN}" -F ref=master https://git.dmx.systems/api/v4/projects/16/trigger/pipeline
  dependencies:
    - maven-build
